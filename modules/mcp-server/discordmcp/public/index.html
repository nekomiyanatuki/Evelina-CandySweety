<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>MCP Control Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
      background: #f6f8fa;
      color: #222;
      padding: 2em;
      margin: 0;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 2em 2em 1em 2em;
    }
    h1 {
      text-align: center;
      color: #2a7ae2;
      margin-bottom: 1.5em;
    }
    .section {
      margin-bottom: 2.5em;
      padding-bottom: 1.5em;
      border-bottom: 1px solid #e0e4ea;
    }
    .section:last-child {
      border-bottom: none;
    }
    label {
      display: block;
      margin: 0.5em 0 0.2em 0;
      font-weight: 500;
    }
    input, select, textarea, button {
      font-size: 1em;
      padding: 0.5em 0.8em;
      margin: 0.2em 0.5em 0.2em 0;
      border-radius: 6px;
      border: 1px solid #bfc9d1;
      background: #fafdff;
      color: #222;
      outline: none;
      transition: border 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      border: 1.5px solid #2a7ae2;
    }
    button {
      background: #2a7ae2;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    button:hover {
      background: #1a5bb8;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      align-items: center;
    }
    .dark-mode {
      background: #23272e !important;
      color: #f6f8fa !important;
    }
    .dark-mode .container {
      background: #2d323b !important;
      color: #f6f8fa !important;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    }
    .dark-mode input, .dark-mode textarea, .dark-mode select {
      background: #23272e;
      color: #f6f8fa;
      border: 1px solid #444b5a;
    }
    .dark-mode button {
      background: #4a90e2;
      color: #fff;
    }
    .dark-mode button:hover {
      background: #357ab8;
    }
    .template-list {
      max-height: 120px;
      overflow-y: auto;
      background: #fafdff;
      border: 1px solid #bfc9d1;
      border-radius: 6px;
      margin-bottom: 0.5em;
      padding: 0.5em;
    }
    .log-area {
      background: #fafdff;
      border: 1px solid #bfc9d1;
      border-radius: 6px;
      padding: 0.5em;
      max-height: 180px;
      overflow-y: auto;
      font-size: 0.95em;
      white-space: pre-wrap;
    }
    .toggle-dark {
      float: right;
      margin-top: -2.5em;
      margin-right: 0.5em;
      background: #e0e4ea;
      color: #2a7ae2;
      border: none;
      padding: 0.3em 1em;
      border-radius: 16px;
      font-size: 0.95em;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle-dark:hover {
      background: #bfc9d1;
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="toggle-dark" onclick="toggleDarkMode()">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
    <h1>Discord MCP ç®¡ç†ãƒ‘ãƒãƒ«</h1>

    <div class="section">
      <h2>âš™ï¸ Botè¨­å®š</h2>
      <div style="background:#eaf4fb;padding:0.7em 1em;border-radius:8px;font-size:0.97em;margin-bottom:0.7em;">
        <b>ä½¿ã„æ–¹ä¾‹:</b> Prefixã¯ <code>/</code> å›ºå®šã§ã™ã€‚é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ã¯ãƒœãƒƒã‚¯ã‚¹å†…ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é€ä¿¡ã§ãã¾ã™ã€‚
      </div>
      <form id="botConfigForm" onsubmit="saveBotConfig(event)">
        <label for="prefix">ã‚³ãƒãƒ³ãƒ‰Prefix</label>
        <input id="prefix" name="prefix" value="/" readonly style="background:#eee;color:#888;">
        <label for="notifyChannelSelect">é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ« <span style="color:#888;font-size:0.9em;">ã‚µãƒ¼ãƒãƒ¼å†…ã®ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã‹ã‚‰é¸æŠ</span></label>
        <select id="notifyChannelSelect" name="notifyChannelSelect" required style="width:100%;"></select>
        <button type="submit">ä¿å­˜</button>
        <span id="botConfigStatus"></span>
      </form>
      <button style="margin-top:1em;background:#f5b942;color:#fff;" onclick="restartBot()">ğŸ”„ Botãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div class="section">
      <h2>ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h2>
      <div style="background:#eaf4fb;padding:0.7em 1em;border-radius:8px;font-size:0.97em;margin-bottom:0.7em;">
        <b>ä½¿ã„æ–¹ä¾‹:</b> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå: <code>æŒ¨æ‹¶</code>ã€å†…å®¹: <code>ã“ã‚“ã«ã¡ã¯ã€ã‚ˆã†ã“ãï¼</code> ãªã©ã€‚ä¿å­˜å¾Œã€ä¸€è¦§ã‹ã‚‰é¸æŠã—ã¦é€ä¿¡ã§ãã¾ã™ã€‚
      </div>
      <div class="row">
        <div style="flex:2;">
          <div class="template-list" id="templateList"></div>
          <button onclick="loadTemplates()">ä¸€è¦§æ›´æ–°</button>
        </div>
        <div style="flex:3;">
          <label for="templateName">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå <span style="color:#888;font-size:0.9em;">ä¾‹: æŒ¨æ‹¶</span></label>
          <input id="templateName" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå">
          <label for="templateContent">å†…å®¹ <span style="color:#888;font-size:0.9em;">ä¾‹: ã“ã‚“ã«ã¡ã¯ã€ã‚ˆã†ã“ãï¼</span></label>
          <textarea id="templateContent" rows="3" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹"></textarea>
          <button onclick="saveTemplate()">ä¿å­˜</button>
          <button onclick="openChannelSelect()">é¸æŠãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé€ä¿¡</button>
          <div id="channelSelectModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1000;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:2em;border-radius:12px;min-width:320px;max-width:90vw;box-shadow:0 4px 24px rgba(0,0,0,0.18);">
              <h3 style="margin-top:0">é€ä¿¡å…ˆãƒãƒ£ãƒ³ãƒãƒ«é¸æŠ</h3>
              <select id="channelSelect" style="width:100%;margin-bottom:1em;"></select>
              <button onclick="sendTemplateToSelected()">é€ä¿¡</button>
              <button onclick="closeChannelSelect()" style="margin-left:1em;background:#ccc;color:#222;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  <div class="section">
      <h2>ğŸ“¨ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</h2>
      <div style="background:#eaf4fb;padding:0.7em 1em;border-radius:8px;font-size:0.97em;margin-bottom:0.7em;">
        <b>ä½¿ã„æ–¹ä¾‹:</b> ãƒãƒ£ãƒ³ãƒãƒ«ID: <code>123456789012345678</code>ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: <code>ãƒ†ã‚¹ãƒˆé€ä¿¡</code>
      </div>
      <form onsubmit="sendMessage(event)">
        <label for="sendChannelSelect">é€ä¿¡å…ˆãƒãƒ£ãƒ³ãƒãƒ« <span style="color:#888;font-size:0.9em;">ã‚µãƒ¼ãƒãƒ¼å†…ã®ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã‹ã‚‰é¸æŠ</span></label>
        <select id="sendChannelSelect" required style="width:100%;"></select>
        <label for="msg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ <span style="color:#888;font-size:0.9em;">ä¾‹: ãƒ†ã‚¹ãƒˆé€ä¿¡</span></label>
        <input id="msg" placeholder="Message" required>
        <button type="submit">é€ä¿¡</button>
      </form>
  </div>

  <div class="section">
      <h2>ğŸ”— Webhooké¢¨Botæ“ä½œ</h2>
      <div style="background:#eaf4fb;padding:0.7em 1em;border-radius:8px;font-size:0.97em;margin-bottom:0.7em;">
        <b>ä½¿ã„æ–¹ä¾‹:</b> ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: <code>sendMessage</code><br>
        ãƒ‡ãƒ¼ã‚¿: <code>{"channelId":"123456789012345678","msg":"Webhookã‹ã‚‰ã®é€ä¿¡ä¾‹"}</code>
      </div>
      <form onsubmit="sendWebhook(event)">
        <label for="webhookAction">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ <span style="color:#888;font-size:0.9em;">ä¾‹: sendMessage</span></label>
        <input id="webhookAction" placeholder="ä¾‹: sendMessage" required>
        <label for="webhookData">ãƒ‡ãƒ¼ã‚¿(JSON) <span style="color:#888;font-size:0.9em;">ä¾‹: {"channelId":"123456789012345678","msg":"Webhookã‹ã‚‰ã®é€ä¿¡ä¾‹"}</span></label>
        <textarea id="webhookData" rows="2" placeholder='{"channelId":"...","msg":"..."}' required></textarea>
        <button type="submit">Webhooké€ä¿¡</button>
        <span id="webhookStatus"></span>
      </form>
  </div>

  <div class="section">
      <h2>ğŸ“œ ã‚³ãƒãƒ³ãƒ‰å±¥æ­´ãƒ»ã‚¨ãƒ©ãƒ¼</h2>
      <div style="background:#eaf4fb;padding:0.7em 1em;border-radius:8px;font-size:0.97em;margin-bottom:0.7em;">
        <b>ãƒ’ãƒ³ãƒˆ:</b> æœ€æ–°ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå±¥æ­´ã‚„ã‚¨ãƒ©ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>Botã®å‹•ä½œç¢ºèªã‚„ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆã«ã”æ´»ç”¨ãã ã•ã„ã€‚
      </div>
      <button onclick="loadLogs()">å±¥æ­´å–å¾—</button>
      <div class="log-area" id="logArea">ï¼ˆã“ã“ã«ã‚³ãƒãƒ³ãƒ‰å±¥æ­´ã‚„ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>
    </div>
  </div>

  <script>
    const token = prompt("MCPãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
    let selectedTemplate = null;

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    // Botè¨­å®šå–å¾—ãƒ»ä¿å­˜
    function loadBotConfig() {
      fetch('/mcp/botconfig', { headers: { 'Authorization': `Bearer ${token}` } })
        .then(r => r.json())
        .then(cfg => {
          document.getElementById('prefix').value = '/';
          fetch('/mcp/channels', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r => r.json())
            .then(data => {
              const select = document.getElementById('notifyChannelSelect');
              select.innerHTML = '';
              (data.channels || []).forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch.id;
                opt.textContent = `${ch.guild} ${ch.name}`;
                select.appendChild(opt);
              });
              if (cfg.notifyChannel) select.value = cfg.notifyChannel;
            });
        });
    }
    function saveBotConfig(e) {
      e.preventDefault();
      const prefix = '/';
      const notifyChannel = document.getElementById('notifyChannelSelect').value;
      fetch('/mcp/botconfig', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ prefix, notifyChannel })
      }).then(r => r.json()).then(res => {
        document.getElementById('botConfigStatus').innerText = res.success ? 'âœ… ä¿å­˜ã—ã¾ã—ãŸ' : 'âŒ å¤±æ•—';
      });
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ãƒ»ä¿å­˜ãƒ»é€ä¿¡
    function loadTemplates() {
      fetch('/mcp/templates', { headers: { 'Authorization': `Bearer ${token}` } })
        .then(r => r.json())
        .then(data => {
          const list = document.getElementById('templateList');
          list.innerHTML = '';
          (data.templates || []).forEach(t => {
            const div = document.createElement('div');
            div.textContent = t.name;
            div.style.cursor = 'pointer';
            div.onclick = () => {
              selectedTemplate = t;
              document.getElementById('templateName').value = t.name;
              document.getElementById('templateContent').value = t.content;
            };
            list.appendChild(div);
          });
        });
    }
    function saveTemplate() {
      const name = document.getElementById('templateName').value;
      const content = document.getElementById('templateContent').value;
      fetch('/mcp/templates', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ name, content })
      }).then(r => r.json()).then(res => {
        if(res.success) loadTemplates();
      });
    }
    function sendTemplate() {
      // æ—§é–¢æ•°ã¯ä½¿ã‚ãªã„
    }
    // ãƒãƒ£ãƒ³ãƒãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openChannelSelect() {
      if (!selectedTemplate) return alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
      const modal = document.getElementById('channelSelectModal');
      const select = document.getElementById('channelSelect');
      select.innerHTML = '<option>èª­ã¿è¾¼ã¿ä¸­...</option>';
      modal.style.display = 'flex';
      fetch('/mcp/channels', { headers: { 'Authorization': `Bearer ${token}` } })
        .then(r => r.json())
        .then(data => {
          select.innerHTML = '';
          (data.channels || []).forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.id;
            opt.textContent = `${ch.guild} ${ch.name}`;
            select.appendChild(opt);
          });
        });
    }
    function closeChannelSelect() {
      document.getElementById('channelSelectModal').style.display = 'none';
    }
    function sendTemplateToSelected() {
      const select = document.getElementById('channelSelect');
      const channelId = select.value;
      closeChannelSelect();
      fetch('/mcp/sendTemplate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ channelId, templateName: selectedTemplate.name })
      }).then(r => r.json()).then(res => {
        alert(res.success ? 'é€ä¿¡ã—ã¾ã—ãŸ' : `é€ä¿¡å¤±æ•—: ${res.error || ''}`);
      });
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    function sendMessage(e) {
      e.preventDefault();
      const channelId = document.getElementById('sendChannelSelect').value;
      const msg = document.getElementById('msg').value;
      if (!channelId || !msg) return alert('ãƒãƒ£ãƒ³ãƒãƒ«ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      fetch('/mcp/sendMessage', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ channelId, msg })
      }).then(r => r.json()).then(data => alert(data.message || JSON.stringify(data)));
    }
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç”¨ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã®åˆæœŸåŒ–
    function loadSendChannels() {
      fetch('/mcp/channels', { headers: { 'Authorization': `Bearer ${token}` } })
        .then(r => r.json())
        .then(data => {
          const select = document.getElementById('sendChannelSelect');
          select.innerHTML = '';
          (data.channels || []).forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.id;
            opt.textContent = `${ch.guild} ${ch.name}`;
            select.appendChild(opt);
          });
        });
    }

    // Webhooké¢¨Botæ“ä½œ
    function sendWebhook(e) {
      e.preventDefault();
      const action = document.getElementById('webhookAction').value;
      let data;
      try {
        data = JSON.parse(document.getElementById('webhookData').value);
      } catch {
        document.getElementById('webhookStatus').innerText = 'âŒ JSONå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
        return;
      }
      fetch('/mcp/webhook', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ action, data })
      }).then(r => r.json()).then(res => {
        document.getElementById('webhookStatus').innerText = res.success ? 'âœ… é€ä¿¡ã—ã¾ã—ãŸ' : 'âŒ å¤±æ•—';
      });
    }

    // ã‚³ãƒãƒ³ãƒ‰å±¥æ­´ãƒ»ã‚¨ãƒ©ãƒ¼å–å¾—
    function loadLogs() {
      fetch('/mcp/commandlog', { headers: { 'Authorization': `Bearer ${token}` } })
        .then(r => r.json())
        .then(data => {
          document.getElementById('logArea').innerText = (data.logs || []).join('\n') || 'å±¥æ­´ãªã—';
        });
    }

    // Botãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
    function restartBot() {
      fetch('/mcp/restart', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      })
        .then(r => r.json())
        .then(data => alert(data.message || JSON.stringify(data)))
        .catch(e => alert('ã‚¨ãƒ©ãƒ¼: ' + e));
    }

    // åˆæœŸãƒ­ãƒ¼ãƒ‰
    loadBotConfig();
    loadTemplates();
    loadSendChannels();
  </script>
</body>
</html>
